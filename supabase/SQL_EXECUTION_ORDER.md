# SQL実行順序ガイド

## 実行順序（重要）

SQLスクリプトは以下の順序で実行してください：

### ステップ1: スキーマの作成（初回のみ）

**ファイル**: `supabase/schema.sql`

**実行タイミング**: プロジェクトの初期セットアップ時のみ

**内容**:
- テーブルの作成（users, observations, subscriptions）
- RLSポリシーの設定
- 関数とトリガーの作成

**注意**: 既にテーブルが存在する場合は、このステップをスキップしてください。

### ステップ2: セキュリティ修正とメール確認（推奨）

**ファイル**: `supabase/clean-fix.sql`

**実行タイミング**: セキュリティ警告を修正したい場合、またはログイン問題を解決したい場合

**内容**:
- `search_path`セキュリティ警告の修正
- メール確認の有効化
- 確認クエリ

**実行方法**:
1. Supabase SQL Editorを開く: https://supabase.com/dashboard/project/lywcdvevizwopochcpic/sql/new
2. `supabase/clean-fix.sql` の内容をコピー＆ペースト
3. Run をクリック

### ステップ3: ユーザーの確認（任意）

**ファイル**: `supabase/check-user-password.sql`

**実行タイミング**: ユーザーの状態を確認したい場合

**内容**:
- ユーザーの存在確認
- パスワードの有無確認（ハッシュ化されているため直接確認不可）
- メール確認の状態確認

## 各SQLファイルの説明

### 1. `schema.sql` - データベーススキーマ

**用途**: 初回セットアップ時にデータベース構造を作成

**実行回数**: 1回のみ（既にテーブルが存在する場合は不要）

**注意事項**:
- 既にテーブルが存在する場合、エラーが発生する可能性があります
- その場合は、`clean-fix.sql`のみを実行してください

### 2. `clean-fix.sql` - セキュリティ修正とメール確認

**用途**: 
- セキュリティ警告（`search_path`）の修正
- メール確認の有効化
- ログイン問題の解決

**実行回数**: 必要に応じて（何度でも実行可能）

**推奨**: 初回セットアップ後、またはログイン問題が発生した場合

### 3. `check-user-password.sql` - ユーザー確認

**用途**: ユーザーの状態を確認

**実行回数**: 必要に応じて（何度でも実行可能）

**注意**: パスワードはハッシュ化されているため、直接確認することはできません

## よくある質問

### Q: どのSQLを実行すればいいですか？

**A:** 
- **初回セットアップ**: `schema.sql` → `clean-fix.sql`
- **既にテーブルが存在する場合**: `clean-fix.sql` のみ
- **ログイン問題を解決したい場合**: `clean-fix.sql`
- **ユーザーの状態を確認したい場合**: `check-user-password.sql`

### Q: `schema.sql`を実行するとエラーが出ます

**A:** 既にテーブルが存在する場合は、`clean-fix.sql`のみを実行してください。`schema.sql`は初回セットアップ時のみ必要です。

### Q: 複数のSQLを一度に実行できますか？

**A:** はい、Supabase SQL Editorでは複数のSQLステートメントを一度に実行できます。ただし、実行順序に注意してください。

## 推奨実行順序（初回セットアップ）

1. `schema.sql` を実行（テーブルが存在しない場合のみ）
2. `clean-fix.sql` を実行（セキュリティ修正とメール確認）
3. `check-user-password.sql` を実行（確認用）

## 推奨実行順序（既にテーブルが存在する場合）

1. `clean-fix.sql` を実行（セキュリティ修正とメール確認）
2. `check-user-password.sql` を実行（確認用）

